import xml.etree.ElementTree as ET
import argparse
import re
import os
import json

pattern = '.*github.com.*commit.*'

parser = argparse.ArgumentParser(description='Get children for CWE')
parser.add_argument('--a', nargs='*', metavar='N1', help='zero or more CWEs', default = [])
args = parser.parse_args()

cwe_id = args.a

tree = ET.parse('cwec_v4.0.xml')
root = tree.getroot()

countID = 0
countNature = 0
familyTree = {}

for weakness in root[0].findall('{http://cwe.mitre.org/cwe-6}Weakness'):
    id = weakness.attrib['ID']
    #print(id)
    countID += 1
    related = (weakness.find('{http://cwe.mitre.org/cwe-6}Related_Weaknesses'))
    if related is not None:
        nature = related.find('{http://cwe.mitre.org/cwe-6}Related_Weakness').attrib['Nature']
        parent = related.find('{http://cwe.mitre.org/cwe-6}Related_Weakness').attrib['CWE_ID']
        #print(nature)
        countNature += 1
        if nature == 'ChildOf':
            if parent in familyTree.keys():
                familyList = familyTree[parent]
                if id not in familyList:
                    familyTree[parent].append(id)
            else:
                familyTree[parent] = [id]

for id in cwe_id:
    if id in familyTree.keys():
        print("CWE-" + str(id), end = " ")
        list = familyTree[id]
        for child in list:
            print("CWE-" + str(child), end = " ")
        #print("\n")

with open("cwe_family_tree.txt", "w+") as output:
    for item in familyTree.items():
        output.write(str(item) + "\n")
